---
import magnolia from '@/lib/magnolia'
import IconArrowRight from '@/assets/icons/arrow-right.svg'
import Layout from '@/components/Layout.astro'
import Image from '@/components/Image'
import Card from '@/components/Card'

const { path, slug } = Astro.params
const lang = Astro.currentLocale!
const { t } = Astro.locals

if (path === 'en' || (path && path !== lang)) {
  return new Response(null, { status: 404 })
}

const [data, lastestPosts] = await Promise.all([
  magnolia.get(`/posts/${slug}`, { lang }),
  magnolia.get<{ results: Record<string, any>[] }>('/posts', {
    '@name[ne]': slug!,
    orderBy: 'createdAt desc,mgnl:lastModified desc',
    limit: '2',
    lang
  })
])
---

<Layout>
  <Image
    class="mt-10 h-52 w-full object-cover md:h-96"
    data={data.image}
    loading="eager"
  />
  <div class="pt-13 px-5 sm:px-10 lg:pb-24 lg:px-13 lg:grid lg:grid-cols-3">
    <article class="lg:pr-13 lg:col-span-2">
      <h1 class="font-bold text-3xl text-pretty text-orange-600 xl:text-5xl">
        {data.title}
      </h1>
      <div
        class:list={[
          'overflow-hidden max-w-none mt-9 prose prose-neutral',
          'prose-img:rounded-lg prose-a:text-red-800 xl:prose-lg'
        ]}
        set:html={data.content}
      />
    </article>
    <section class="my-24 lg:mt-2 lg:mb-0">
      <h2 class="mb-9 text-2xl text-orange-600 uppercase">
        {t['other_posts']}
      </h2>
      <div class="grid gap-y-12 gap-x-5 sm:grid-cols-2 lg:grid-cols-1">
        {
          lastestPosts.results.map((post) => (
            <Card {...post} lang={lang} label={t['learn_more']}>
              <IconArrowRight class="w-2.75" />
            </Card>
          ))
        }
      </div>
    </section>
  </div>
</Layout>
